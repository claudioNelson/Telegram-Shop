// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============
enum UserRole {
  ADMIN
  SHOP_OWNER
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  CREATED
  SUCCEEDED
  FAILED
  CANCELLED
}

enum ProductUnit {
  PIECE
  GRAM
  KG
  ML
  L
  TABLET
  PILL
  BOX
  PACK
}

// ============ USERS (f√ºr Admin-Panel) ============
model User {
  id             Int            @id @default(autoincrement())
  email          String         @unique
  passwordHash   String
  role           UserRole       @default(SHOP_OWNER)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  shops          Shop[]
  twoFaConfig    TwoFaConfig?

  @@map("users")
}

// ============ 2FA CONFIG (PGP-basiert) ============
model TwoFaConfig {
  id            Int       @id @default(autoincrement())
  userId        Int       @unique
  publicKeyPgp  String    @db.Text  // User's PGP Public Key
  isEnabled     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_fa_configs")
}

// ============ SHOPS (Multi-Mandanten) ============
model Shop {
  id            Int       @id @default(autoincrement())
  name          String
  publicName    String
  slug          String    @unique
  ownerUserId   Int
  imprintText   String?   @db.Text
  privacyPolicyText String? @db.Text
  email         String?
  
  // Wallet-Felder f√ºr Crypto Payments
  btcAddress    String?   // Bitcoin
  ethAddress    String?   // Ethereum
  ltcAddress    String?   // Litecoin
  usdtAddress   String?   // USDT (Ethereum)
  xmrAddress    String?   // Monero

  // Email Notifications
  notificationsEnabled  Boolean   @default(false)
  notificationEmail     String?   // Email wo Benachrichtigungen hin
  notifyOnOrder         Boolean   @default(true)
  notifyOnLowStock      Boolean   @default(true)
  
  // Stock Warning
  lowStockThreshold     Int       @default(5)  // Warnung wenn Stock < 5
  
  // Bot Settings
  botWelcomeMessage     String    @default("Welcome to our shop! üõç") @db.Text
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  owner         User      @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  bots          Bot[]
  products      Product[]
  customers     Customer[]
  orders        Order[]
  commissions   Commission[]

  @@map("shops")
}

// ============ BOTS (pro Shop sein eigener Bot) ============
model Bot {
  id                    Int       @id @default(autoincrement())
  shopId                Int
  name                  String?
  telegramBotToken      String    @unique
  telegramBotUsername   String
  welcomeMessage        String    @db.Text
  languageDefault       String    @default("de")
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  shop                  Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("bots")
}

// ============ PRODUCTS ============
model Product {
  id            Int       @id @default(autoincrement())
  shopId        Int
  title         String
  description   String    @db.Text
  priceCents    Int       // In Cents (z.B. 1999 = 19,99‚Ç¨)
  currency      String    @default("EUR")
  isDigital     Boolean   @default(false)
  unit          ProductUnit @default(PIECE)
  stockQuantity Int?      // nullable f√ºr digitale Produkte
  isActive      Boolean   @default(true)
  imageUrl      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
  tiers         ProductTier[]

  @@map("products")
}

// ============ PRODUCT TIERS (Staffelpreise) ============
model ProductTier {
  id              Int       @id @default(autoincrement())
  productId       Int
  minQuantity     Int
  maxQuantity     Int?
  priceCents      Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_tiers")
}

// ============ CUSTOMERS (Telegram-Nutzer) ============
model Customer {
  id                Int       @id @default(autoincrement())
  shopId            Int
  telegramUserId    BigInt
  telegramUsername  String?
  firstName         String?
  lastName          String?
  email             String?
  shippingAddressJson String?  @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  shop              Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  orders            Order[]

  @@map("customers")
}

// ============ ORDERS ============
model Order {
  id                        Int       @id @default(autoincrement())
  shopId                    Int
  customerId                Int
  status                    OrderStatus @default(PENDING_PAYMENT)
  totalAmountCents          Int
  currency                  String    @default("EUR")
  isDigital                 Boolean   @default(false)
  shippingAddressJson       String?   @db.Text
  paymentProvider           String    @default("stripe")
  paymentProviderSessionId  String?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  commission                Commission?

  // Relations
  shop                      Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  customer                  Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items                     OrderItem[]
  payment                   Payment?

  @@map("orders")
}

// ============ ORDER ITEMS ============
model OrderItem {
  id              Int       @id @default(autoincrement())
  orderId         Int
  productId       Int
  quantity        Int
  unitPriceCents  Int
  totalPriceCents Int
  createdAt       DateTime  @default(now())

  // Relations
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

// ============ PAYMENTS ============
model Payment {
  id                      Int       @id @default(autoincrement())
  orderId                 Int       @unique
  provider                String    @default("stripe")
  providerPaymentIntentId String?
  status                  PaymentStatus @default(CREATED)
  amountCents             Int
  currency                String    @default("EUR")
  rawWebhookPayloadJson   String?   @db.Text
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  order                   Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ============ COMMISSION MODEL ============
model Commission {
  id            Int       @id @default(autoincrement())
  orderId       Int       @unique
  shopId        Int
  orderAmount   Int
  commissionPct Float
  commissionAmount Int
  status        String    @default("PENDING")
  createdAt     DateTime  @default(now())
  
  order         Order     @relation(fields: [orderId], references: [id])
  shop          Shop      @relation(fields: [shopId], references: [id])
}

// ============ PACKAGES (SaaS Plans) ============
model Package {
  id                Int       @id @default(autoincrement())
  name              String
  description       String?   @db.Text
  priceEur          Int
  commissionPercent Float     @default(5.0)
  billingType       String
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("packages")
}
